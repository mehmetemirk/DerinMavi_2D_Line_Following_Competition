name: Update Leaderboard

on:
  workflow_run:
    workflows: ["Evaluate Submission"]
    types:
      - completed

jobs:
  update-leaderboard:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: competition-results
          path: artifacts
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Read Artifacts
        id: read
        env:
          PR_BASE_BRANCH: ${{ github.event.workflow_run.pull_requests[0].base.ref }}
        run: |
          SCORE=$(cat artifacts/score.txt)
          USER=$(cat artifacts/user.txt)
          PR_URL=$(cat artifacts/pr_url.txt)
          
          if [ -f artifacts/branch.txt ]; then
            BRANCH=$(cat artifacts/branch.txt)
            echo "Branch from artifact: $BRANCH"
          elif [ -n "$PR_BASE_BRANCH" ] && [ "$PR_BASE_BRANCH" != "null" ]; then
            BRANCH="$PR_BASE_BRANCH"
            echo "Branch from PR context: $BRANCH"
          else
            echo "Warning: Could not determine branch. Defaulting to main."
            BRANCH="main"
          fi
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "user=$USER" >> $GITHUB_OUTPUT
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout Target Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.read.outputs.branch }}
          repository: ${{ github.repository }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Leaderboard File
        run: |
          python update_leaderboard.py "${{ steps.read.outputs.score }}" "${{ steps.read.outputs.user }}"

      - name: Commit Leaderboard
        run: |
          git config --global user.name 'Leaderboard Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add README.md
          if git diff --staged --quiet; then
            echo "No changes to leaderboard"
          else
            git commit -m "Update Leaderboard: ${{ steps.read.outputs.user }} - ${{ steps.read.outputs.score }}s"
            git push origin HEAD:${{ steps.read.outputs.branch }}
          fi
